"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.toMatchCdkSnapshot = void 0;
const assertions_1 = require("aws-cdk-lib/assertions");
const jest_snapshot_1 = require("jest-snapshot");
const jsYaml = __importStar(require("js-yaml"));
const currentVersionRegex = /^(.+CurrentVersion[0-9A-F]{8})[0-9a-f]{32}$/;
const toMatchCdkSnapshot = function (received, options = {}) {
    const matcher = jest_snapshot_1.toMatchSnapshot.bind(this);
    const { propertyMatchers, ...convertOptions } = options;
    const stack = convertStack(received, convertOptions);
    return propertyMatchers ? matcher(stack, propertyMatchers) : matcher(stack);
};
exports.toMatchCdkSnapshot = toMatchCdkSnapshot;
const maskCurrentVersionRefs = (tree) => {
    if (tree == null) {
        return;
    }
    if (Array.isArray(tree)) {
        for (let i = 0; i < tree.length; i++) {
            const value = tree[i];
            if (typeof value === "string") {
                const match = currentVersionRegex.exec(value);
                if (match) {
                    tree[i] = `${match[1]}xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`;
                }
            }
            else if (typeof value === "object") {
                maskCurrentVersionRefs(value);
            }
        }
    }
    else if (typeof tree === "object") {
        for (const [key, value] of Object.entries(tree)) {
            const keyMatch = currentVersionRegex.exec(key);
            if (keyMatch) {
                const newKey = `${keyMatch[1]}xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`;
                tree[newKey] = value;
                delete tree[key];
            }
            if (typeof value === "string") {
                const valueMatch = currentVersionRegex.exec(value);
                if (valueMatch) {
                    tree[key] = `${valueMatch[1]}xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx`;
                }
            }
            else if (typeof value === "object") {
                maskCurrentVersionRefs(value);
            }
        }
    }
};
const convertStack = (stack, options = {}) => {
    const { yaml, ignoreAssets = false, ignoreBootstrapVersion = true, ignoreCurrentVersion = false, ignoreMetadata = false, ignoreTags = false, subsetResourceTypes, subsetResourceKeys, ...synthOptions } = options;
    if (Object.keys(synthOptions).length > 0) {
        console.warn("Synth options are no longer supported. Please remove them.");
    }
    const template = assertions_1.Template.fromStack(stack, {}).toJSON();
    if (ignoreBootstrapVersion) {
        if (template.Parameters) {
            delete template.Parameters.BootstrapVersion;
            if (Object.keys(template.Parameters).length === 0) {
                delete template.Parameters;
            }
        }
        if (template.Rules) {
            delete template.Rules.CheckBootstrapVersion;
            if (Object.keys(template.Rules).length === 0) {
                delete template.Rules;
            }
        }
    }
    if (ignoreAssets && template.Resources) {
        const anyObject = yaml ? "Any<Object>" : expect.any(Object);
        if (template.Parameters) {
            template.Parameters = anyObject;
        }
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        Object.values(template.Resources).forEach((resource) => {
            var _a, _b, _c;
            if ((_a = resource === null || resource === void 0 ? void 0 : resource.Properties) === null || _a === void 0 ? void 0 : _a.Code) {
                resource.Properties.Code = anyObject;
            }
            if ((_b = resource === null || resource === void 0 ? void 0 : resource.Properties) === null || _b === void 0 ? void 0 : _b.ContainerDefinitions) {
                (_c = resource === null || resource === void 0 ? void 0 : resource.Properties) === null || _c === void 0 ? void 0 : _c.ContainerDefinitions.forEach(
                // eslint-disable-next-line @typescript-eslint/no-explicit-any
                (definition) => {
                    definition.Image = anyObject;
                });
            }
        });
    }
    if (ignoreCurrentVersion && template.Resources) {
        maskCurrentVersionRefs(template);
    }
    if (subsetResourceTypes && template.Resources) {
        for (const [key, resource] of Object.entries(template.Resources)) {
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            if (!subsetResourceTypes.includes(resource.Type)) {
                delete template.Resources[key];
            }
        }
    }
    if (subsetResourceKeys && template.Resources) {
        for (const [key] of Object.entries(template.Resources)) {
            if (!subsetResourceKeys.includes(key)) {
                delete template.Resources[key];
            }
        }
    }
    if (ignoreMetadata && template.Metadata) {
        delete template.Metadata;
    }
    if (ignoreMetadata && template.Resources) {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        Object.values(template.Resources).forEach((resource) => {
            if (resource === null || resource === void 0 ? void 0 : resource.Metadata) {
                delete resource.Metadata;
            }
        });
    }
    if (ignoreTags && template.Resources) {
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        Object.values(template.Resources).forEach((resource) => {
            var _a;
            if ((_a = resource === null || resource === void 0 ? void 0 : resource.Properties) === null || _a === void 0 ? void 0 : _a.Tags) {
                delete resource.Properties.Tags;
            }
        });
    }
    return yaml ? jsYaml.safeDump(template) : template;
};
if (expect !== undefined) {
    expect.extend({ toMatchCdkSnapshot: exports.toMatchCdkSnapshot });
}
else {
    console.error("Unable to find Jest's global expect." +
        "\nPlease check you have added jest-cdk-snapshot correctly." +
        "\nSee https://github.com/hupe1980/jest-cdk-snapshot for help.");
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSx1REFBa0Q7QUFFbEQsaURBQWdEO0FBQ2hELGdEQUFrQztBQXVFbEMsTUFBTSxtQkFBbUIsR0FBRyw2Q0FBNkMsQ0FBQztBQUVuRSxNQUFNLGtCQUFrQixHQUFHLFVBR2hDLFFBQWUsRUFDZixVQUFtQixFQUFFO0lBRXJCLE1BQU0sT0FBTyxHQUFHLCtCQUFlLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNDLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxHQUFHLGNBQWMsRUFBRSxHQUFHLE9BQU8sQ0FBQztJQUV4RCxNQUFNLEtBQUssR0FBRyxZQUFZLENBQUMsUUFBUSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0lBRXJELE9BQU8sZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzlFLENBQUMsQ0FBQztBQVpXLFFBQUEsa0JBQWtCLHNCQVk3QjtBQUVGLE1BQU0sc0JBQXNCLEdBQUcsQ0FBQyxJQUFhLEVBQVEsRUFBRTtJQUNyRCxJQUFJLElBQUksSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUNqQixPQUFPO0lBQ1QsQ0FBQztJQUNELElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ3hCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDckMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RCLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzlCLE1BQU0sS0FBSyxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDOUMsSUFBSSxLQUFLLEVBQUUsQ0FBQztvQkFDVixJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLGtDQUFrQyxDQUFDO2dCQUMxRCxDQUFDO1lBQ0gsQ0FBQztpQkFBTSxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRSxDQUFDO2dCQUNyQyxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQyxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7U0FBTSxJQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQ3BDLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDaEQsTUFBTSxRQUFRLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQy9DLElBQUksUUFBUSxFQUFFLENBQUM7Z0JBQ2IsTUFBTSxNQUFNLEdBQUcsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLGtDQUFrQyxDQUFDO2dCQUNoRSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsS0FBSyxDQUFDO2dCQUNyQixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQixDQUFDO1lBRUQsSUFBSSxPQUFPLEtBQUssS0FBSyxRQUFRLEVBQUUsQ0FBQztnQkFDOUIsTUFBTSxVQUFVLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUNuRCxJQUFJLFVBQVUsRUFBRSxDQUFDO29CQUNmLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUMsa0NBQWtDLENBQUM7Z0JBQ2pFLENBQUM7WUFDSCxDQUFDO2lCQUFNLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQ3JDLHNCQUFzQixDQUFDLEtBQWdDLENBQUMsQ0FBQztZQUMzRCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDLENBQUM7QUFFRixNQUFNLFlBQVksR0FBRyxDQUFDLEtBQVksRUFBRSxVQUFtQixFQUFFLEVBQUUsRUFBRTtJQUMzRCxNQUFNLEVBQ0osSUFBSSxFQUNKLFlBQVksR0FBRyxLQUFLLEVBQ3BCLHNCQUFzQixHQUFHLElBQUksRUFDN0Isb0JBQW9CLEdBQUcsS0FBSyxFQUM1QixjQUFjLEdBQUcsS0FBSyxFQUN0QixVQUFVLEdBQUcsS0FBSyxFQUNsQixtQkFBbUIsRUFDbkIsa0JBQWtCLEVBQ2xCLEdBQUcsWUFBWSxFQUNoQixHQUFHLE9BQU8sQ0FBQztJQUVaLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDekMsT0FBTyxDQUFDLElBQUksQ0FBQyw0REFBNEQsQ0FBQyxDQUFDO0lBQzdFLENBQUM7SUFFRCxNQUFNLFFBQVEsR0FBRyxxQkFBUSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUM7SUFFeEQsSUFBSSxzQkFBc0IsRUFBRSxDQUFDO1FBQzNCLElBQUksUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3hCLE9BQU8sUUFBUSxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQztZQUM1QyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDbEQsT0FBTyxRQUFRLENBQUMsVUFBVSxDQUFDO1lBQzdCLENBQUM7UUFDSCxDQUFDO1FBRUQsSUFBSSxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDbkIsT0FBTyxRQUFRLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDO1lBQzVDLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUM3QyxPQUFPLFFBQVEsQ0FBQyxLQUFLLENBQUM7WUFDeEIsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0lBRUQsSUFBSSxZQUFZLElBQUksUUFBUSxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ3ZDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTVELElBQUksUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3hCLFFBQVEsQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO1FBQ2xDLENBQUM7UUFFRCw4REFBOEQ7UUFDOUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUU7O1lBQzFELElBQUksTUFBQSxRQUFRLGFBQVIsUUFBUSx1QkFBUixRQUFRLENBQUUsVUFBVSwwQ0FBRSxJQUFJLEVBQUUsQ0FBQztnQkFDL0IsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDO1lBQ3ZDLENBQUM7WUFFRCxJQUFJLE1BQUEsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLFVBQVUsMENBQUUsb0JBQW9CLEVBQUUsQ0FBQztnQkFDL0MsTUFBQSxRQUFRLGFBQVIsUUFBUSx1QkFBUixRQUFRLENBQUUsVUFBVSwwQ0FBRSxvQkFBb0IsQ0FBQyxPQUFPO2dCQUNoRCw4REFBOEQ7Z0JBQzlELENBQUMsVUFBZSxFQUFFLEVBQUU7b0JBQ2xCLFVBQVUsQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDO2dCQUMvQixDQUFDLENBQ0YsQ0FBQztZQUNKLENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLG9CQUFvQixJQUFJLFFBQVEsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUMvQyxzQkFBc0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQsSUFBSSxtQkFBbUIsSUFBSSxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDOUMsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDakUsOERBQThEO1lBQzlELElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUUsUUFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUMxRCxPQUFPLFFBQVEsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDakMsQ0FBQztRQUNILENBQUM7SUFDSCxDQUFDO0lBRUQsSUFBSSxrQkFBa0IsSUFBSSxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDN0MsS0FBSyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztZQUN2RCxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3RDLE9BQU8sUUFBUSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNqQyxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRCxJQUFJLGNBQWMsSUFBSSxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDeEMsT0FBTyxRQUFRLENBQUMsUUFBUSxDQUFDO0lBQzNCLENBQUM7SUFFRCxJQUFJLGNBQWMsSUFBSSxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDekMsOERBQThEO1FBQzlELE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQWEsRUFBRSxFQUFFO1lBQzFELElBQUksUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLFFBQVEsRUFBRSxDQUFDO2dCQUN2QixPQUFPLFFBQVEsQ0FBQyxRQUFRLENBQUM7WUFDM0IsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELElBQUksVUFBVSxJQUFJLFFBQVEsQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUNyQyw4REFBOEQ7UUFDOUQsTUFBTSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBYSxFQUFFLEVBQUU7O1lBQzFELElBQUksTUFBQSxRQUFRLGFBQVIsUUFBUSx1QkFBUixRQUFRLENBQUUsVUFBVSwwQ0FBRSxJQUFJLEVBQUUsQ0FBQztnQkFDL0IsT0FBTyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQztZQUNsQyxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQztBQUNyRCxDQUFDLENBQUM7QUFFRixJQUFJLE1BQU0sS0FBSyxTQUFTLEVBQUUsQ0FBQztJQUN6QixNQUFNLENBQUMsTUFBTSxDQUFDLEVBQUUsa0JBQWtCLEVBQWxCLDBCQUFrQixFQUFFLENBQUMsQ0FBQztBQUN4QyxDQUFDO0tBQU0sQ0FBQztJQUNOLE9BQU8sQ0FBQyxLQUFLLENBQ1gsc0NBQXNDO1FBQ3BDLDREQUE0RDtRQUM1RCwrREFBK0QsQ0FDbEUsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZW1wbGF0ZSB9IGZyb20gXCJhd3MtY2RrLWxpYi9hc3NlcnRpb25zXCI7XG5pbXBvcnQgeyBTdGFjaywgU3RhZ2VTeW50aGVzaXNPcHRpb25zIH0gZnJvbSBcImF3cy1jZGstbGliXCI7XG5pbXBvcnQgeyB0b01hdGNoU25hcHNob3QgfSBmcm9tIFwiamVzdC1zbmFwc2hvdFwiO1xuaW1wb3J0ICogYXMganNZYW1sIGZyb20gXCJqcy15YW1sXCI7XG5cbmRlY2xhcmUgZ2xvYmFsIHtcbiAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1uYW1lc3BhY2VcbiAgbmFtZXNwYWNlIGplc3Qge1xuICAgIGludGVyZmFjZSBNYXRjaGVyczxSPiB7XG4gICAgICB0b01hdGNoQ2RrU25hcHNob3Qob3B0aW9ucz86IE9wdGlvbnMpOiBSO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgdHlwZSBPcHRpb25zID0gU3RhZ2VTeW50aGVzaXNPcHRpb25zICYge1xuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgTm8gZWZmZWN0LiBQbGVhc2UgcmVtb3ZlIHRoaXMsIHRoZXJlIGlzIG5vIGFsdGVybmF0aXZlLlxuICAgKi9cbiAgcmVhZG9ubHkgc2tpcFZhbGlkYXRpb24/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBAZGVwcmVjYXRlZCBObyBlZmZlY3QuIFBsZWFzZSByZW1vdmUgdGhpcywgdGhlcmUgaXMgbm8gYWx0ZXJuYXRpdmUuXG4gICAqL1xuICByZWFkb25seSB2YWxpZGF0ZU9uU3ludGhlc2lzPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogQGRlcHJlY2F0ZWQgTm8gZWZmZWN0LiBQbGVhc2UgcmVtb3ZlIHRoaXMsIHRoZXJlIGlzIG5vIGFsdGVybmF0aXZlLlxuICAgKi9cbiAgcmVhZG9ubHkgZm9yY2U/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBPdXRwdXQgc25hcHNob3RzIGluIFlBTUwgKGluc3RlYWQgb2YgSlNPTilcbiAgICovXG4gIHlhbWw/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBJZ25vcmUgQXNzZXRzXG4gICAqL1xuICBpZ25vcmVBc3NldHM/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBJZ25vcmUgTGFtYmRhIEN1cnJlbnQgVmVyc2lvblxuICAgKi9cbiAgaWdub3JlQ3VycmVudFZlcnNpb24/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBNYXRjaCBvbmx5IHJlc291cmNlcyBvZiBnaXZlbiB0eXBlc1xuICAgKi9cbiAgc3Vic2V0UmVzb3VyY2VUeXBlcz86IHN0cmluZ1tdO1xuXG4gIC8qKlxuICAgKiBNYXRjaCBvbmx5IHJlc291cmNlcyBvZiBnaXZlbiBrZXlzXG4gICAqL1xuICBzdWJzZXRSZXNvdXJjZUtleXM/OiBzdHJpbmdbXTtcblxuICBwcm9wZXJ0eU1hdGNoZXJzPzogeyBbcHJvcGVydHk6IHN0cmluZ106IHVua25vd24gfTtcblxuICAvKipcbiAgICogRXhjbHVkZXMgQ0RLIHYyLW1hbmFnZWQgYm9vdHN0cmFwIHZlcnNpb25zLlxuICAgKiBEZWZhdWx0cyB0byBgdHJ1ZWAuXG4gICAqL1xuICBpZ25vcmVCb290c3RyYXBWZXJzaW9uPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogSWdub3JlIE1ldGFkYXRhXG4gICAqL1xuICBpZ25vcmVNZXRhZGF0YT86IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIElnbm9yZSBUYWdzIG9uIHJlc291cmNlc1xuICAgKi9cbiAgaWdub3JlVGFncz86IGJvb2xlYW47XG59O1xuXG5jb25zdCBjdXJyZW50VmVyc2lvblJlZ2V4ID0gL14oLitDdXJyZW50VmVyc2lvblswLTlBLUZdezh9KVswLTlhLWZdezMyfSQvO1xuXG5leHBvcnQgY29uc3QgdG9NYXRjaENka1NuYXBzaG90ID0gZnVuY3Rpb24gKFxuICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICB0aGlzOiBhbnksXG4gIHJlY2VpdmVkOiBTdGFjayxcbiAgb3B0aW9uczogT3B0aW9ucyA9IHt9LFxuKSB7XG4gIGNvbnN0IG1hdGNoZXIgPSB0b01hdGNoU25hcHNob3QuYmluZCh0aGlzKTtcbiAgY29uc3QgeyBwcm9wZXJ0eU1hdGNoZXJzLCAuLi5jb252ZXJ0T3B0aW9ucyB9ID0gb3B0aW9ucztcblxuICBjb25zdCBzdGFjayA9IGNvbnZlcnRTdGFjayhyZWNlaXZlZCwgY29udmVydE9wdGlvbnMpO1xuXG4gIHJldHVybiBwcm9wZXJ0eU1hdGNoZXJzID8gbWF0Y2hlcihzdGFjaywgcHJvcGVydHlNYXRjaGVycykgOiBtYXRjaGVyKHN0YWNrKTtcbn07XG5cbmNvbnN0IG1hc2tDdXJyZW50VmVyc2lvblJlZnMgPSAodHJlZTogdW5rbm93bik6IHZvaWQgPT4ge1xuICBpZiAodHJlZSA9PSBudWxsKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIGlmIChBcnJheS5pc0FycmF5KHRyZWUpKSB7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0cmVlLmxlbmd0aDsgaSsrKSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHRyZWVbaV07XG4gICAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGNvbnN0IG1hdGNoID0gY3VycmVudFZlcnNpb25SZWdleC5leGVjKHZhbHVlKTtcbiAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgdHJlZVtpXSA9IGAke21hdGNoWzFdfXh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4YDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgbWFza0N1cnJlbnRWZXJzaW9uUmVmcyh2YWx1ZSk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2UgaWYgKHR5cGVvZiB0cmVlID09PSBcIm9iamVjdFwiKSB7XG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXModHJlZSkpIHtcbiAgICAgIGNvbnN0IGtleU1hdGNoID0gY3VycmVudFZlcnNpb25SZWdleC5leGVjKGtleSk7XG4gICAgICBpZiAoa2V5TWF0Y2gpIHtcbiAgICAgICAgY29uc3QgbmV3S2V5ID0gYCR7a2V5TWF0Y2hbMV19eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHhgO1xuICAgICAgICB0cmVlW25ld0tleV0gPSB2YWx1ZTtcbiAgICAgICAgZGVsZXRlIHRyZWVba2V5XTtcbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICBjb25zdCB2YWx1ZU1hdGNoID0gY3VycmVudFZlcnNpb25SZWdleC5leGVjKHZhbHVlKTtcbiAgICAgICAgaWYgKHZhbHVlTWF0Y2gpIHtcbiAgICAgICAgICB0cmVlW2tleV0gPSBgJHt2YWx1ZU1hdGNoWzFdfXh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4YDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgbWFza0N1cnJlbnRWZXJzaW9uUmVmcyh2YWx1ZSBhcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPik7XG4gICAgICB9XG4gICAgfVxuICB9XG59O1xuXG5jb25zdCBjb252ZXJ0U3RhY2sgPSAoc3RhY2s6IFN0YWNrLCBvcHRpb25zOiBPcHRpb25zID0ge30pID0+IHtcbiAgY29uc3Qge1xuICAgIHlhbWwsXG4gICAgaWdub3JlQXNzZXRzID0gZmFsc2UsXG4gICAgaWdub3JlQm9vdHN0cmFwVmVyc2lvbiA9IHRydWUsXG4gICAgaWdub3JlQ3VycmVudFZlcnNpb24gPSBmYWxzZSxcbiAgICBpZ25vcmVNZXRhZGF0YSA9IGZhbHNlLFxuICAgIGlnbm9yZVRhZ3MgPSBmYWxzZSxcbiAgICBzdWJzZXRSZXNvdXJjZVR5cGVzLFxuICAgIHN1YnNldFJlc291cmNlS2V5cyxcbiAgICAuLi5zeW50aE9wdGlvbnNcbiAgfSA9IG9wdGlvbnM7XG5cbiAgaWYgKE9iamVjdC5rZXlzKHN5bnRoT3B0aW9ucykubGVuZ3RoID4gMCkge1xuICAgIGNvbnNvbGUud2FybihcIlN5bnRoIG9wdGlvbnMgYXJlIG5vIGxvbmdlciBzdXBwb3J0ZWQuIFBsZWFzZSByZW1vdmUgdGhlbS5cIik7XG4gIH1cblxuICBjb25zdCB0ZW1wbGF0ZSA9IFRlbXBsYXRlLmZyb21TdGFjayhzdGFjaywge30pLnRvSlNPTigpO1xuXG4gIGlmIChpZ25vcmVCb290c3RyYXBWZXJzaW9uKSB7XG4gICAgaWYgKHRlbXBsYXRlLlBhcmFtZXRlcnMpIHtcbiAgICAgIGRlbGV0ZSB0ZW1wbGF0ZS5QYXJhbWV0ZXJzLkJvb3RzdHJhcFZlcnNpb247XG4gICAgICBpZiAoT2JqZWN0LmtleXModGVtcGxhdGUuUGFyYW1ldGVycykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGRlbGV0ZSB0ZW1wbGF0ZS5QYXJhbWV0ZXJzO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0ZW1wbGF0ZS5SdWxlcykge1xuICAgICAgZGVsZXRlIHRlbXBsYXRlLlJ1bGVzLkNoZWNrQm9vdHN0cmFwVmVyc2lvbjtcbiAgICAgIGlmIChPYmplY3Qua2V5cyh0ZW1wbGF0ZS5SdWxlcykubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIGRlbGV0ZSB0ZW1wbGF0ZS5SdWxlcztcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBpZiAoaWdub3JlQXNzZXRzICYmIHRlbXBsYXRlLlJlc291cmNlcykge1xuICAgIGNvbnN0IGFueU9iamVjdCA9IHlhbWwgPyBcIkFueTxPYmplY3Q+XCIgOiBleHBlY3QuYW55KE9iamVjdCk7XG5cbiAgICBpZiAodGVtcGxhdGUuUGFyYW1ldGVycykge1xuICAgICAgdGVtcGxhdGUuUGFyYW1ldGVycyA9IGFueU9iamVjdDtcbiAgICB9XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIE9iamVjdC52YWx1ZXModGVtcGxhdGUuUmVzb3VyY2VzKS5mb3JFYWNoKChyZXNvdXJjZTogYW55KSA9PiB7XG4gICAgICBpZiAocmVzb3VyY2U/LlByb3BlcnRpZXM/LkNvZGUpIHtcbiAgICAgICAgcmVzb3VyY2UuUHJvcGVydGllcy5Db2RlID0gYW55T2JqZWN0O1xuICAgICAgfVxuXG4gICAgICBpZiAocmVzb3VyY2U/LlByb3BlcnRpZXM/LkNvbnRhaW5lckRlZmluaXRpb25zKSB7XG4gICAgICAgIHJlc291cmNlPy5Qcm9wZXJ0aWVzPy5Db250YWluZXJEZWZpbml0aW9ucy5mb3JFYWNoKFxuICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgICAgICAgKGRlZmluaXRpb246IGFueSkgPT4ge1xuICAgICAgICAgICAgZGVmaW5pdGlvbi5JbWFnZSA9IGFueU9iamVjdDtcbiAgICAgICAgICB9LFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgaWYgKGlnbm9yZUN1cnJlbnRWZXJzaW9uICYmIHRlbXBsYXRlLlJlc291cmNlcykge1xuICAgIG1hc2tDdXJyZW50VmVyc2lvblJlZnModGVtcGxhdGUpO1xuICB9XG5cbiAgaWYgKHN1YnNldFJlc291cmNlVHlwZXMgJiYgdGVtcGxhdGUuUmVzb3VyY2VzKSB7XG4gICAgZm9yIChjb25zdCBba2V5LCByZXNvdXJjZV0gb2YgT2JqZWN0LmVudHJpZXModGVtcGxhdGUuUmVzb3VyY2VzKSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICAgIGlmICghc3Vic2V0UmVzb3VyY2VUeXBlcy5pbmNsdWRlcygocmVzb3VyY2UgYXMgYW55KS5UeXBlKSkge1xuICAgICAgICBkZWxldGUgdGVtcGxhdGUuUmVzb3VyY2VzW2tleV07XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKHN1YnNldFJlc291cmNlS2V5cyAmJiB0ZW1wbGF0ZS5SZXNvdXJjZXMpIHtcbiAgICBmb3IgKGNvbnN0IFtrZXldIG9mIE9iamVjdC5lbnRyaWVzKHRlbXBsYXRlLlJlc291cmNlcykpIHtcbiAgICAgIGlmICghc3Vic2V0UmVzb3VyY2VLZXlzLmluY2x1ZGVzKGtleSkpIHtcbiAgICAgICAgZGVsZXRlIHRlbXBsYXRlLlJlc291cmNlc1trZXldO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGlmIChpZ25vcmVNZXRhZGF0YSAmJiB0ZW1wbGF0ZS5NZXRhZGF0YSkge1xuICAgIGRlbGV0ZSB0ZW1wbGF0ZS5NZXRhZGF0YTtcbiAgfVxuXG4gIGlmIChpZ25vcmVNZXRhZGF0YSAmJiB0ZW1wbGF0ZS5SZXNvdXJjZXMpIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWV4cGxpY2l0LWFueVxuICAgIE9iamVjdC52YWx1ZXModGVtcGxhdGUuUmVzb3VyY2VzKS5mb3JFYWNoKChyZXNvdXJjZTogYW55KSA9PiB7XG4gICAgICBpZiAocmVzb3VyY2U/Lk1ldGFkYXRhKSB7XG4gICAgICAgIGRlbGV0ZSByZXNvdXJjZS5NZXRhZGF0YTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGlmIChpZ25vcmVUYWdzICYmIHRlbXBsYXRlLlJlc291cmNlcykge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgT2JqZWN0LnZhbHVlcyh0ZW1wbGF0ZS5SZXNvdXJjZXMpLmZvckVhY2goKHJlc291cmNlOiBhbnkpID0+IHtcbiAgICAgIGlmIChyZXNvdXJjZT8uUHJvcGVydGllcz8uVGFncykge1xuICAgICAgICBkZWxldGUgcmVzb3VyY2UuUHJvcGVydGllcy5UYWdzO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcmV0dXJuIHlhbWwgPyBqc1lhbWwuc2FmZUR1bXAodGVtcGxhdGUpIDogdGVtcGxhdGU7XG59O1xuXG5pZiAoZXhwZWN0ICE9PSB1bmRlZmluZWQpIHtcbiAgZXhwZWN0LmV4dGVuZCh7IHRvTWF0Y2hDZGtTbmFwc2hvdCB9KTtcbn0gZWxzZSB7XG4gIGNvbnNvbGUuZXJyb3IoXG4gICAgXCJVbmFibGUgdG8gZmluZCBKZXN0J3MgZ2xvYmFsIGV4cGVjdC5cIiArXG4gICAgICBcIlxcblBsZWFzZSBjaGVjayB5b3UgaGF2ZSBhZGRlZCBqZXN0LWNkay1zbmFwc2hvdCBjb3JyZWN0bHkuXCIgK1xuICAgICAgXCJcXG5TZWUgaHR0cHM6Ly9naXRodWIuY29tL2h1cGUxOTgwL2plc3QtY2RrLXNuYXBzaG90IGZvciBoZWxwLlwiLFxuICApO1xufVxuIl19